<!DOCTYPE html>
<html lang="en">
<!-- Previous head content remains the same until the charts initialization -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        h1 {
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .chart-container {
            margin: 20px 40px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: grab;
        }
        .chart-container:active {
            cursor: grabbing;
        }
        .navigation {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .navigation a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            margin-right: 15px;
            padding: 5px 10px;
            border-radius: 3px;
            transition: background-color 0.3s ease;
        }
        
        .navigation a:hover {
            background-color: #e2e6ea;
            text-decoration: underline;
        }
        .footer {
            margin-top: 20px;
            text-align: center;
            color: #666;
        }
        .date-selection {
            margin: 10px auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: fit-content;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .date-selection input[type="date"] {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .date-selection button {
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .date-selection button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <nav class="navigation">
            <a href="/">Home</a>
            <a href="/chart">Charts</a>
            <a href="/map">Map</a>
            <a href="/growing-areas">Growing Areas</a>
            <a href="/devices">Devices and API Key</a>
            <a href="/logout" style="color: #c74b58;">Logout</a>
        </nav>

        <h1 class="text-center">Data Chart</h1>

        <div class="row">
            <div class="col-12">
                <div class="date-selection">
                    <span>Select From Date: </span>
                    <input type="date" id="fromDate" name="fromDate">
                    <span>Select To Date: </span>
                    <input type="date" id="toDate" name="toDate">
                    <button type="button" id="updateChartButton">Update Chart</button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <h5 class="mb-3">Select Data to Display</h5>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tempCheckBox" checked>
                    <label class="form-check-label" for="tempCheckBox">Nhiệt độ (°C)</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="humidCheckBox" checked>
                    <label class="form-check-label" for="humidCheckBox">Độ ẩm (%)</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="phCheckBox" checked>
                    <label class="form-check-label" for="phCheckBox">pH</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="condCheckBox" checked>
                    <label class="form-check-label" for="condCheckBox">Độ dẫn điện</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="nCheckBox" checked>
                    <label class="form-check-label" for="nCheckBox">Nitrogen</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="pCheckBox" checked>
                    <label class="form-check-label" for="pCheckBox">Phosphorus</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="kCheckBox" checked>
                    <label class="form-check-label" for="kCheckBox">Potassium</label>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="tempHumidChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="phCondChart"></canvas>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <canvas id="npkChart"></canvas>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2024 Sensor Data Dashboard</p>
        </div>
    </div>

    <script>
        let charts = {};
        let dataBuffer = {
            tempHumid: [],
            phCond: [],
            npk: []
        };
        const maxDataPoints = 15;
        let lastTimestamp = null;

        // Common animation configuration
        const commonAnimation = {
            duration: 400,
            easing: 'easeInOutQuad'
        };

        const zoomOptions = {
            zoom: {
                wheel: {
                    enabled: true
                },
                pinch: {
                    enabled: true
                },
                mode: 'x',
                drag: {
                    enabled: true,
                    backgroundColor: 'rgba(225,225,225,0.3)',
                    borderColor: 'rgba(225,225,225)',
                    borderWidth: 1,
                    threshold: 2
                }
            },
            pan: {
                enabled: true,
                mode: 'x',
                modifierKey: null,
                onPanStart: function(chart) {
                    chart.canvas.style.cursor = 'grabbing';
                },
                onPanComplete: function(chart) {
                    chart.canvas.style.cursor = 'grab';
                    handlePan(chart);
                }
            }
        };

        // Common chart options
        const commonOptions = {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            animation: commonAnimation,
            transitions: {
                show: {
                    animations: {
                        x: {
                            from: 0
                        },
                        y: {
                            from: 0
                        }
                    }
                },
                hide: {
                    animations: {
                        x: {
                            to: 0
                        },
                        y: {
                            to: 0
                        }
                    }
                }
            }
        };

        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
        }

        function initCharts() {
            charts.tempHumid = new Chart(document.getElementById('tempHumidChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Nhiệt độ (°C)',
                            borderColor: '#ff6384',
                            yAxisID: 'y-temp',
                            tension: 0.4,
                            borderWidth: 2,
                            hidden: !document.getElementById('tempCheckBox').checked
                        },
                        {
                            label: 'Độ ẩm (%)',
                            borderColor: '#36a2eb',
                            yAxisID: 'y-humid',
                            tension: 0.4,
                            borderWidth: 2,
                            hidden: !document.getElementById('humidCheckBox').checked
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        'y-temp': {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Nhiệt độ (°C)'
                            }
                        },
                        'y-humid': {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Độ ẩm (%)'
                            }
                        }
                    },
                    plugins: {
                        zoom: zoomOptions
                    }
                }
            });

            charts.phCond = new Chart(document.getElementById('phCondChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'pH',
                            borderColor: '#4bc0c0',
                            yAxisID: 'y-ph',
                            tension: 0.4,
                            borderWidth: 2,
                            hidden: !document.getElementById('phCheckBox').checked
                        },
                        {
                            label: 'Độ dẫn điện',
                            borderColor: '#9966ff',
                            yAxisID: 'y-cond',
                            tension: 0.4,
                            borderWidth: 2,
                            hidden: !document.getElementById('condCheckBox').checked
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        'y-ph': {
                            type: 'linear',
                            position: 'left',
                            min: 0,
                            max: 14,
                            title: {
                                display: true,
                                text: 'pH'
                            }
                        },
                        'y-cond': {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Độ dẫn điện'
                            }
                        }
                    },
                    plugins: {
                        zoom: zoomOptions
                    }
                }
            });

            charts.npk = new Chart(document.getElementById('npkChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Nitrogen',
                            borderColor: '#ff9f40',
                            tension: 0.4,
                            borderWidth: 2,
                            hidden: !document.getElementById('nCheckBox').checked
                        },
                        {
                            label: 'Phosphorus',
                            borderColor: '#ffcd56',
                            tension: 0.4,
                            borderWidth: 2,
                            hidden: !document.getElementById('pCheckBox').checked
                        },
                        {
                            label: 'Potassium',
                            borderColor: '#4bc0c0',
                            tension: 0.4,
                            borderWidth: 2,
                            hidden: !document.getElementById('kCheckBox').checked
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Giá trị'
                            }
                        }
                    },
                    plugins: {
                        zoom: zoomOptions
                    }
                }
            });
        }

        function handlePan(chart) {
            const min = chart.scales.x.min;
            if (min && min < lastTimestamp) {
                fetchMoreData(min);
            }
        }

        function updateCharts(data) {
            data = data.reverse();

            dataBuffer.tempHumid = [];
            dataBuffer.phCond = [];
            dataBuffer.npk = [];

            dataBuffer.tempHumid = data.slice(-maxDataPoints);
            charts.tempHumid.data.labels = dataBuffer.tempHumid.map(item => new Date(item.timestamp).toLocaleDateString() + ' ' + new Date(item.timestamp).toLocaleTimeString());
            charts.tempHumid.data.datasets[0].data = dataBuffer.tempHumid.map(item => item.temperature);
            charts.tempHumid.data.datasets[1].data = dataBuffer.tempHumid.map(item => item.humidity);
            charts.tempHumid.update('active');

            dataBuffer.phCond = data.slice(-maxDataPoints);
            charts.phCond.data.labels = dataBuffer.phCond.map(item => new Date(item.timestamp).toLocaleDateString() + ' ' + new Date(item.timestamp).toLocaleTimeString());
            charts.phCond.data.datasets[0].data = dataBuffer.phCond.map(item => item.ph);
            charts.phCond.data.datasets[1].data = dataBuffer.phCond.map(item => item.conductivity);
            charts.phCond.update('active');

            dataBuffer.npk = data.slice(-maxDataPoints);
            charts.npk.data.labels = dataBuffer.npk.map(item => new Date(item.timestamp).toLocaleDateString() + ' ' + new Date(item.timestamp).toLocaleTimeString());
            charts.npk.data.datasets[0].data = dataBuffer.npk.map(item => item.nitrogen);
            charts.npk.data.datasets[1].data = dataBuffer.npk.map(item => item.phosphorus);
            charts.npk.data.datasets[2].data = dataBuffer.npk.map(item => item.potassium);
            charts.npk.update('active');
        }

        async function fetchData(useFilters = false) {
            try {
                let url = '/api/data/chart';
                if (useFilters) {
                    const start = document.getElementById('fromDate').value;
                    const end = document.getElementById('toDate').value;
                    if (!start || !end) {
                        alert('Please select both dates');
                        return;
                    }
                    url += `?start=${start}&end=${end}`;
                }
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.length > 0) {
                    lastTimestamp = new Date(data[0].timestamp).getTime();
                    updateCharts(data);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function fetchMoreData(panOffset) {
            try {
                const response = await fetch(`/api/data/chart?start=${new Date(panOffset).toISOString()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.length > 0) {
                    lastTimestamp = new Date(data[data.length - 1].timestamp).getTime();
                    updateCharts(data);
                }
            } catch (error) {
                console.error('Error fetching more data:', error);
            }
        }

        function handleCheckboxChange() {
            const tempCheckBox = document.getElementById('tempCheckBox');
            const humidCheckBox = document.getElementById('humidCheckBox');
            const phCheckBox = document.getElementById('phCheckBox');
            const condCheckBox = document.getElementById('condCheckBox');
            const nCheckBox = document.getElementById('nCheckBox');
            const pCheckBox = document.getElementById('pCheckBox');
            const kCheckBox = document.getElementById('kCheckBox');

            charts.tempHumid.data.datasets[0].hidden = !tempCheckBox.checked;
            charts.tempHumid.data.datasets[1].hidden = !humidCheckBox.checked;
            charts.tempHumid.update('active');

            charts.phCond.data.datasets[0].hidden = !phCheckBox.checked;
            charts.phCond.data.datasets[1].hidden = !condCheckBox.checked;
            charts.phCond.update('active');

            charts.npk.data.datasets[0].hidden = !nCheckBox.checked;
            charts.npk.data.datasets[1].hidden = !pCheckBox.checked;
            charts.npk.data.datasets[2].hidden = !kCheckBox.checked;
            charts.npk.update('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDates();
            initCharts();
            fetchData(false); // Load initial data

            // Handle checkbox changes
            document.querySelectorAll('.form-check-input').forEach((input) => {
                input.addEventListener('change', handleCheckboxChange);
            });

            // Handle update chart button click
            document.getElementById('updateChartButton').addEventListener('click', () => {
                fetchData(true); // Load filtered data
            });
        });
    </script>
</body>
</html>
